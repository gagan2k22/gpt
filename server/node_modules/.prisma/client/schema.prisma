// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User & Auth
model User {
  id            Int        @id @default(autoincrement())
  name          String
  email         String     @unique
  password_hash String
  is_active     Boolean    @default(true)
  created_at    DateTime   @default(now())
  updated_at    DateTime   @default(now()) @updatedAt
  roles         UserRole[]

  created_pos  PO[]       @relation("CreatedBy")
  approved_pos PO[]       @relation("ApprovedBy")
  audit_logs   AuditLog[]
}

model Role {
  id    Int        @id @default(autoincrement())
  name  String     @unique // Viewer, Editor, Approver, Admin
  users UserRole[]
}

model UserRole {
  id      Int  @id @default(autoincrement())
  user_id Int
  role_id Int
  user    User @relation(fields: [user_id], references: [id])
  role    Role @relation(fields: [role_id], references: [id])

  @@unique([user_id, role_id])
}

// Master Data
model Tower {
  id           Int          @id @default(autoincrement())
  name         String
  budget_heads BudgetHead[]
  budget_boas  BudgetBOA[]
  pos          PO[]
  line_items   LineItem[]
  actuals_boas ActualsBOA[]
}

model BudgetHead {
  id           Int          @id @default(autoincrement())
  name         String
  tower_id     Int
  tower        Tower        @relation(fields: [tower_id], references: [id])
  budget_boas  BudgetBOA[]
  pos          PO[]
  line_items   LineItem[]
  actuals_boas ActualsBOA[]
}

model Vendor {
  id             Int        @id @default(autoincrement())
  name           String
  gst_number     String?
  contact_person String?
  pos            PO[]
  line_items     LineItem[]
}

model CostCentre {
  id           Int          @id @default(autoincrement())
  code         String       @unique
  description  String?
  budget_boas  BudgetBOA[]
  actuals_boas ActualsBOA[]
}

model POEntity {
  id         Int        @id @default(autoincrement())
  name       String     @unique
  pos        PO[]
  line_items LineItem[]
}

model ServiceType {
  id         Int        @id @default(autoincrement())
  name       String     @unique // Shared Service, Dedicated Service
  line_items LineItem[]
}

model AllocationBasis {
  id           Int          @id @default(autoincrement())
  name         String       @unique
  budget_boas  BudgetBOA[]
  line_items   LineItem[]
  actuals_boas ActualsBOA[]
}

model FiscalYear {
  id          Int      @id @default(autoincrement())
  year        Int      @unique // e.g., 2025, 2026, 2027
  label       String // e.g., "FY25", "FY26", "FY27"
  description String? // Optional description
  is_active   Boolean  @default(true)
  start_date  DateTime
  end_date    DateTime
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

// Budget Management
model BudgetBOA {
  id                   Int     @id @default(autoincrement())
  fiscal_year          Int // e.g., 2025
  tower_id             Int
  budget_head_id       Int
  cost_centre_id       Int
  allocation_basis_id  Int?
  annual_budget_amount Float
  remarks              String?

  tower            Tower            @relation(fields: [tower_id], references: [id])
  budget_head      BudgetHead       @relation(fields: [budget_head_id], references: [id])
  cost_centre      CostCentre       @relation(fields: [cost_centre_id], references: [id])
  allocation_basis AllocationBasis? @relation(fields: [allocation_basis_id], references: [id])

  monthly_breakdown    BudgetMonthly[]
  calculations         BudgetCalculation?
  actuals_calculations ActualsCalculation[]

  @@unique([fiscal_year, tower_id, budget_head_id, cost_centre_id])
}

model BudgetMonthly {
  id            Int   @id @default(autoincrement())
  budget_boa_id Int
  month         Int // 1-12
  budget_amount Float

  budget_boa BudgetBOA @relation(fields: [budget_boa_id], references: [id])
}

model BudgetCalculation {
  id                    Int    @id @default(autoincrement())
  budget_boa_id         Int    @unique
  fy25_budget           Float?
  fy25_actual           Float?
  fy26_budget_with_hike Float?
  variance_to_fy25      Float?
  variance_to_fy26      Float?

  budget_boa BudgetBOA @relation(fields: [budget_boa_id], references: [id])
}

// PO & Line Items
model PO {
  id             Int    @id @default(autoincrement())
  po_number      String @unique
  vendor_id      Int
  tower_id       Int
  budget_head_id Int
  po_entity_id   Int?

  // PR (Purchase Requisition) Fields
  pr_number String?
  pr_date   DateTime?
  pr_amount Float?

  // PO Fields
  po_date        DateTime
  po_start_date  DateTime?
  po_end_date    DateTime?
  total_po_value Float
  currency       String    @default("INR")

  // Common Currency Fields (for standardization)
  common_currency       String @default("INR")
  common_currency_value Float? // Value converted to common currency
  value_in_lac          Float? // Value in Lakhs (INR)

  status         String    @default("Draft") // Draft, Submitted, Approved, Rejected, Closed
  created_by_id  Int
  approved_by_id Int?
  approval_date  DateTime?
  remarks        String?

  vendor      Vendor     @relation(fields: [vendor_id], references: [id])
  tower       Tower      @relation(fields: [tower_id], references: [id])
  budget_head BudgetHead @relation(fields: [budget_head_id], references: [id])
  po_entity   POEntity?  @relation(fields: [po_entity_id], references: [id])
  created_by  User       @relation("CreatedBy", fields: [created_by_id], references: [id])
  approved_by User?      @relation("ApprovedBy", fields: [approved_by_id], references: [id])

  line_items LineItem[]
}

model LineItem {
  id                     Int       @id @default(autoincrement())
  uid                    String    @unique // DIT-OPEX FY25-001
  parent_uid             String?
  po_id                  Int?
  vendor_id              Int
  service_description    String
  service_start_date     DateTime?
  service_end_date       DateTime?
  tower_id               Int
  budget_head_id         Int
  po_entity_id           Int?
  service_type_id        Int?
  allocation_basis_id    Int?
  is_renewal             Boolean   @default(false)
  unit_cost              Float
  quantity               Int
  total_cost             Float
  fiscal_year            Int? // e.g., 2025, 2026, 2027
  fy25_allocation_amount Float?
  fy26_allocation_amount Float?
  fy27_allocation_amount Float?
  remarks                String?

  po               PO?              @relation(fields: [po_id], references: [id])
  vendor           Vendor           @relation(fields: [vendor_id], references: [id])
  tower            Tower            @relation(fields: [tower_id], references: [id])
  budget_head      BudgetHead       @relation(fields: [budget_head_id], references: [id])
  po_entity        POEntity?        @relation(fields: [po_entity_id], references: [id])
  service_type     ServiceType?     @relation(fields: [service_type_id], references: [id])
  allocation_basis AllocationBasis? @relation(fields: [allocation_basis_id], references: [id])

  actuals_basis ActualsBasis[]
}

// Actuals
model ActualsBOA {
  id                  Int     @id @default(autoincrement())
  fiscal_year         Int
  month               Int // 1-12
  tower_id            Int
  budget_head_id      Int
  cost_centre_id      Int
  allocation_basis_id Int?
  actual_amount       Float
  remarks             String?

  tower            Tower            @relation(fields: [tower_id], references: [id])
  budget_head      BudgetHead       @relation(fields: [budget_head_id], references: [id])
  cost_centre      CostCentre       @relation(fields: [cost_centre_id], references: [id])
  allocation_basis AllocationBasis? @relation(fields: [allocation_basis_id], references: [id])

  basis        ActualsBasis[]
  calculations ActualsCalculation[]

  @@unique([fiscal_year, month, tower_id, budget_head_id, cost_centre_id])
}

model ActualsBasis {
  id                    Int    @id @default(autoincrement())
  actual_boa_id         Int
  line_item_id          Int? // Reference to Line Item
  allocation_percentage Float?
  allocated_amount      Float

  actual_boa ActualsBOA @relation(fields: [actual_boa_id], references: [id])
  line_item  LineItem?  @relation(fields: [line_item_id], references: [id])
}

model ActualsCalculation {
  id                  Int      @id @default(autoincrement())
  budget_boa_id       Int
  actuals_boa_id      Int
  variance_amount     Float
  variance_percentage Float
  run_date            DateTime @default(now())

  budget_boa  BudgetBOA  @relation(fields: [budget_boa_id], references: [id])
  actuals_boa ActualsBOA @relation(fields: [actuals_boa_id], references: [id])
}

// Audit
model AuditLog {
  id          Int      @id @default(autoincrement())
  user_id     Int
  action      String // CREATE_PO, UPDATE_BUDGET
  entity_type String // PO, BUDGET
  entity_id   String
  old_value   String? // JSON string
  new_value   String? // JSON string
  timestamp   DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
}
